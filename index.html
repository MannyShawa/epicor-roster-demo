<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Epicor, Resource Rostering Calendar</title>
  <link rel="icon" type="image/png" href="assets/epicor-favicon.png" />

  <style>
    :root{
      --epicor-blue: #0B5CAB;
      --epicor-blue-2: #0A4B8C;
      --epicor-accent: #F28C00;

      --bg: #F6F8FB;
      --card: #FFFFFF;
      --text: #111827;
      --muted: #6B7280;
      --line: #E5E7EB;
      --shadow: 0 8px 22px rgba(17, 24, 39, 0.08);
      --radius: 14px;

      --slot: #FFFFFF;
      --slot-hover: #F3F7FF;

      --danger-bg: #FDE2E2;
      --danger-text: #B91C1C;
    }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Segoe UI", Arial, sans-serif; background: var(--bg); color: var(--text); }

    .topbar{
      background: linear-gradient(90deg, var(--epicor-blue), var(--epicor-blue-2));
      color: #fff;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }
    .logo{ height: 26px; width: auto; display:block; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.15)); }
    .title-wrap{ display:flex; flex-direction:column; line-height:1.1; }
    .title-wrap h1{ margin:0; font-size: 18px; font-weight: 800; letter-spacing: 0.2px; }
    .title-wrap .subtitle{ font-size: 12px; opacity: 0.9; }

    .container{ max-width: 1400px; margin: 18px auto; padding: 0 16px 22px; }

    .layout{
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 14px;
      align-items: start;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card-header{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      background: #fff;
    }
    .card-header .heading{ font-size: 13px; font-weight: 800; margin:0; }
    .card-header .hint{ font-size: 12px; color: var(--muted); margin-top: 3px; }

    .btn{
      border: 0;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 800;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    .btn-primary{ background: var(--epicor-blue); color: #fff; }
    .btn-accent{ background: var(--epicor-accent); color: #111827; }
    .btn:active{ transform: translateY(1px); }

    .controls{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }

    /* Backlog */
    .backlog{
      padding: 10px 12px 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .job{
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 10px;
      background: #fff;
      box-shadow: 0 10px 18px rgba(17,24,39,0.06);
      cursor: grab;
    }
    .job:active{ cursor: grabbing; }
    .job .top{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      font-size: 11px;
      background: #fff;
      color: #0F172A;
      white-space: nowrap;
    }
    .job .name{ font-weight: 800; font-size: 12px; }
    .job .meta{ font-size: 12px; color: var(--muted); display:flex; gap: 8px; flex-wrap: wrap; }

    /* Board */
    .board-wrap{ padding: 10px 12px 14px; overflow:auto; }
    .board{
      min-width: 980px;
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      background: #fff;
    }

    .grid{
      display: grid;
      grid-template-columns: 220px repeat(7, minmax(140px, 1fr));
    }

    .cell{
      border-right: 1px solid var(--line);
      border-bottom: 1px solid var(--line);
      padding: 10px;
      background: var(--slot);
      min-height: 86px;
    }

    .cell.header{
      background: #F3F6FB;
      font-weight: 800;
      font-size: 12px;
      color: #0F172A;
      min-height: unset;
      padding: 12px 10px;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .cell.resource{
      background: #FAFBFF;
      font-weight: 800;
      font-size: 12px;
      color: #0F172A;
      position: sticky;
      left: 0;
      z-index: 1;
    }

    .resource-sub{
      display:block;
      font-weight: 600;
      color: var(--muted);
      font-size: 11px;
      margin-top: 4px;
    }

    .dropzone{
      border-radius: 12px;
      min-height: 66px;
      padding: 8px;
      border: 1px dashed rgba(11, 92, 171, 0.22);
      background: rgba(11, 92, 171, 0.03);
      display:flex;
      flex-direction: column;
      gap: 8px;
      transition: background 120ms ease, border-color 120ms ease;
    }

    .dropzone.over{
      background: var(--slot-hover);
      border-color: rgba(11, 92, 171, 0.45);
    }

    /* Job block when scheduled */
    .block{
      border-radius: 12px;
      padding: 9px 9px;
      border: 1px solid rgba(11, 92, 171, 0.20);
      background: rgba(11, 92, 171, 0.08);
      cursor: grab;
    }
    .block:active{ cursor: grabbing; }
    .block .line1{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    .block .title{ font-weight: 900; font-size: 12px; }
    .block .small{ font-size: 11px; color: var(--muted); display:flex; gap: 8px; flex-wrap: wrap; }
    .block .warn{ color: var(--danger-text); font-weight: 900; }

    .footer-note{
      padding: 10px 14px;
      border-top: 1px solid var(--line);
      font-size: 12px;
      color: var(--muted);
      background: #fff;
    }

    @media (max-width: 1100px){
      .layout{ grid-template-columns: 1fr; }
      .board{ min-width: 900px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <img class="logo" src="assets/epicor-logo.svg" alt="Epicor" onerror="this.style.display='none'"/>
    <div class="title-wrap">
      <h1>Resource Rostering, Calendar Board</h1>
      <div class="subtitle">Drag jobs onto a resource and day, drop onto another job to swap</div>
    </div>
  </div>

  <div class="container">
    <div class="layout">
      <!-- Backlog -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="heading">Job Backlog</div>
            <div class="hint">Drag a job onto the board</div>
          </div>
          <div class="controls">
            <button class="btn btn-accent" onclick="resetDemo()">Reset</button>
          </div>
        </div>

        <div class="backlog" id="backlog"></div>

        <div class="footer-note">
          Demo mode only, later we load jobs and resources from Epicor REST, then POST updates back.
        </div>
      </div>

      <!-- Board -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="heading">Schedule</div>
            <div class="hint">Drop into a cell, drag between cells, drop onto an occupied cell to swap</div>
          </div>
          <div class="controls">
            <button class="btn btn-primary" onclick="saveChanges()">Save Changes</button>
          </div>
        </div>

        <div class="board-wrap">
          <div class="board" id="board"></div>
        </div>

        <div class="footer-note">
          Next iteration, time slots (hour blocks) inside each day, plus multi day jobs, plus filters.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Demo data ----------
    const demoResources = [
      { id: "EMP001", name: "John Smith", group: "Assembly" },
      { id: "EMP002", name: "Sarah Lee", group: "Welding" },
      { id: "EMP003", name: "Michael Tran", group: "Paint" },
      { id: "EMP004", name: "Aisha Khan", group: "Assembly" }
    ];

    const demoJobs = [
      { jobId: "J-10021", title: "Switchboard build", hours: 6, priority: "High" },
      { jobId: "J-10034", title: "Panel wiring", hours: 4, priority: "Med" },
      { jobId: "J-10040", title: "Factory test", hours: 3, priority: "Low" },
      { jobId: "J-10055", title: "Cut, drill, bend", hours: 5, priority: "High" },
      { jobId: "J-10080", title: "Powder coat prep", hours: 4, priority: "Med" }
    ];

    // This is the schedule state.
    // Key format: `${resourceId}|${dayKey}`
    // Value: job object
    let resources = structuredClone(demoResources);
    let backlogJobs = structuredClone(demoJobs);
    let schedule = {}; // map cellKey -> job

    // A simple 7 day view starting from Monday of the current week.
    function getWeek() {
      const now = new Date();
      const day = now.getDay(); // 0 Sun ... 6 Sat
      const diffToMonday = (day === 0 ? -6 : 1) - day;
      const monday = new Date(now);
      monday.setDate(now.getDate() + diffToMonday);
      monday.setHours(0,0,0,0);

      const days = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        const key = d.toISOString().slice(0,10);
        const label = d.toLocaleDateString(undefined, { weekday: "short", day: "2-digit", month: "short" });
        days.push({ key, label });
      }
      return days;
    }

    const weekDays = getWeek();

    // ---------- Rendering ----------
    function render() {
      renderBacklog();
      renderBoard();
    }

    function renderBacklog() {
      const el = document.getElementById("backlog");
      el.innerHTML = "";

      backlogJobs.forEach(job => {
        el.appendChild(renderJobCard(job, "backlog"));
      });

      if (backlogJobs.length === 0) {
        const empty = document.createElement("div");
        empty.style.color = "#6B7280";
        empty.style.fontSize = "12px";
        empty.textContent = "Backlog empty, all jobs are scheduled.";
        el.appendChild(empty);
      }
    }

    function renderBoard() {
      const board = document.getElementById("board");
      board.innerHTML = "";

      const grid = document.createElement("div");
      grid.className = "grid";

      // Header row
      grid.appendChild(headerCell("Resource"));
      weekDays.forEach(d => grid.appendChild(headerCell(d.label)));

      // Rows
      resources.forEach(r => {
        grid.appendChild(resourceCell(r));
        weekDays.forEach(d => {
          const cellKey = makeCellKey(r.id, d.key);
          grid.appendChild(scheduleCell(cellKey, r, d));
        });
      });

      board.appendChild(grid);
    }

    function headerCell(text) {
      const c = document.createElement("div");
      c.className = "cell header";
      c.textContent = text;
      return c;
    }

    function resourceCell(r) {
      const c = document.createElement("div");
      c.className = "cell resource";
      c.innerHTML = `
        <div>${escapeHtml(r.name)}</div>
        <span class="resource-sub">${escapeHtml(r.group)} , ${escapeHtml(r.id)}</span>
      `;
      return c;
    }

    function scheduleCell(cellKey, resource, day) {
      const c = document.createElement("div");
      c.className = "cell";
      c.dataset.cellKey = cellKey;

      const dz = document.createElement("div");
      dz.className = "dropzone";
      dz.dataset.cellKey = cellKey;

      // Drag over styles
      dz.addEventListener("dragover", (e) => {
        e.preventDefault();
        dz.classList.add("over");
      });
      dz.addEventListener("dragleave", () => dz.classList.remove("over"));
      dz.addEventListener("drop", (e) => {
        e.preventDefault();
        dz.classList.remove("over");
        const payload = safeParse(e.dataTransfer.getData("text/plain"));
        if (!payload) return;
        handleDrop(payload, cellKey);
      });

      // If scheduled, show job block
      const job = schedule[cellKey];
      if (job) {
        dz.appendChild(renderJobCard(job, "scheduled", cellKey));
      } else {
        const hint = document.createElement("div");
        hint.style.fontSize = "11px";
        hint.style.color = "#6B7280";
        hint.textContent = "Drop job here";
        dz.appendChild(hint);
      }

      c.appendChild(dz);
      return c;
    }

    function renderJobCard(job, mode, cellKey) {
      const card = document.createElement("div");
      card.className = mode === "scheduled" ? "block" : "job";
      card.draggable = true;

      // payload for DnD
      const payload = {
        type: "job",
        from: mode,         // backlog or scheduled
        cellKey: cellKey || null,
        job: job
      };

      card.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", JSON.stringify(payload));
        e.dataTransfer.effectAllowed = "move";
      });

      const warn = job.hours >= 6 ? `<span class="warn">Heavy</span>` : "";
      card.innerHTML = `
        <div class="top">
          <div class="name">${escapeHtml(job.jobId)} , ${escapeHtml(job.title)}</div>
          <span class="badge">${escapeHtml(job.priority)}</span>
        </div>
        <div class="${mode === "scheduled" ? "small" : "meta"}">
          <span>${escapeHtml(String(job.hours))}h</span>
          ${warn ? `<span class="warn">${warn.replace(/<[^>]*>?/gm,'')}</span>` : ""}
        </div>
      `;
      return card;
    }

    // ---------- Drag-drop logic ----------
    function handleDrop(payload, targetCellKey) {
      if (!payload || payload.type !== "job") return;

      const incomingJob = payload.job;
      const targetHasJob = !!schedule[targetCellKey];
      const sourceFromBacklog = payload.from === "backlog";
      const sourceFromScheduled = payload.from === "scheduled";
      const sourceCellKey = payload.cellKey;

      if (sourceFromScheduled && sourceCellKey === targetCellKey) return;

      if (sourceFromBacklog) {
        // remove from backlog
        backlogJobs = backlogJobs.filter(j => j.jobId !== incomingJob.jobId);

        if (!targetHasJob) {
          schedule[targetCellKey] = incomingJob;
        } else {
          // swap with target, push target back to backlog
          const displaced = schedule[targetCellKey];
          schedule[targetCellKey] = incomingJob;
          backlogJobs.unshift(displaced);
        }
        render();
        return;
      }

      if (sourceFromScheduled) {
        const sourceJob = schedule[sourceCellKey];
        if (!sourceJob) return;

        if (!targetHasJob) {
          // move
          delete schedule[sourceCellKey];
          schedule[targetCellKey] = sourceJob;
        } else {
          // swap
          const targetJob = schedule[targetCellKey];
          schedule[targetCellKey] = sourceJob;
          schedule[sourceCellKey] = targetJob;
        }
        render();
        return;
      }
    }

    // ---------- Save / Reset ----------
    function saveChanges() {
      // In next phase this becomes REST calls.
      // For now, log the schedule in a clean structure.
      const out = [];
      Object.keys(schedule).forEach(cellKey => {
        const [resourceId, dayKey] = cellKey.split("|");
        out.push({
          resourceId,
          day: dayKey,
          jobId: schedule[cellKey].jobId,
          title: schedule[cellKey].title,
          hours: schedule[cellKey].hours,
          priority: schedule[cellKey].priority
        });
      });

      console.log("Schedule payload:", out);
      alert("Saved (demo). Check console for schedule payload.");
    }

    function resetDemo() {
      resources = structuredClone(demoResources);
      backlogJobs = structuredClone(demoJobs);
      schedule = {};
      render();
    }

    function makeCellKey(resourceId, dayKey) {
      return `${resourceId}|${dayKey}`;
    }

    function safeParse(s) {
      try { return JSON.parse(s); } catch { return null; }
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    render();
  </script>
</body>
</html>
