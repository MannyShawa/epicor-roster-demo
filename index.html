<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Epicor, Weekly Resource Calendar</title>
  <link rel="icon" type="image/png" href="assets/epicor-favicon.png" />

  <style>
    :root{
      --dark-petrol: #002b3a;
      --petrol: #053c55;
      --light-gray: #eef2f5;
      --bright-blue: #008cf8;
      --lemon: #fcdd00;
      --grid: #d7dde3;

      --bg: #f7f9fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #6b7280;
      --shadow: 0 10px 24px rgba(17, 24, 39, 0.08);
      --radius: 14px;
    }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Segoe UI", Arial, sans-serif; background: var(--bg); color: var(--text); }

    .topbar{
      background: linear-gradient(90deg, var(--petrol), var(--dark-petrol));
      color: #fff;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }
    .logo{ height: 26px; width: auto; display:block; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.15)); }
    .title-wrap{ display:flex; flex-direction:column; line-height:1.15; }
    .title-wrap h1{ margin:0; font-size: 18px; font-weight: 800; letter-spacing: 0.2px; }
    .title-wrap .subtitle{ font-size: 12px; opacity: 0.9; }

    .container{ max-width: 1650px; margin: 16px auto; padding: 0 16px 22px; }

    .layout{
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 12px;
      align-items: start;
    }

    .card{
      background: var(--card);
      border: 1px solid #e5e7eb;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card-header{
      padding: 12px 14px;
      border-bottom: 1px solid #e5e7eb;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      background: #fff;
    }

    .card-header .heading{ font-size: 13px; font-weight: 900; margin:0; }
    .card-header .hint{ font-size: 12px; color: var(--muted); margin-top: 3px; }

    .controls{ display:flex; gap: 8px; flex-wrap: wrap; align-items: center; justify-content: flex-end; }
    .btn{
      border: 0;
      border-radius: 10px;
      padding: 10px 12px;
      font-weight: 900;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background: var(--bright-blue); color: #fff; }
    .btn-secondary{ background: var(--light-gray); color: var(--text); border: 1px solid #dde3ea; }
    .btn-warn{ background: var(--lemon); color: #111827; }

    .select{
      border: 1px solid #dde3ea;
      background: #fff;
      border-radius: 10px;
      padding: 9px 10px;
      font-weight: 900;
      font-size: 12px;
      color: var(--text);
      outline: none;
      cursor: pointer;
    }

    /* Backlog jobs */
    .backlog{
      padding: 10px 12px 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .job{
      border: 1px solid #dde3ea;
      border-radius: 10px;
      padding: 10px 10px;
      background: #fff;
      box-shadow: 0 10px 18px rgba(17,24,39,0.06);
      cursor: grab;
    }
    .job:active{ cursor: grabbing; }
    .job .top{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #dde3ea;
      font-size: 11px;
      background: #fff;
      color: #0f172a;
      white-space: nowrap;
    }
    .job .name{ font-weight: 900; font-size: 12px; }
    .job .meta{ font-size: 12px; color: var(--muted); display:flex; gap: 8px; flex-wrap: wrap; }

    /* Board */
    .board-wrap{
      padding: 10px 12px 14px;
      overflow: auto;
      background: #fff;
    }

    .excel{
      min-width: 1400px;
      border: 1px solid var(--grid);
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
    }

    .grid{ display: grid; }

    .cell{
      border-right: 1px solid var(--grid);
      border-bottom: 1px solid var(--grid);
      padding: 10px;
      background: #fff;
      min-height: 104px;
    }

    .cell.header{
      background: var(--light-gray);
      font-weight: 900;
      font-size: 12px;
      color: #0f172a;
      min-height: unset;
      padding: 10px;
      position: sticky;
      top: 0;
      z-index: 3;
    }

    .cell.header.weekend{
      background: rgba(252, 221, 0, 0.22);
    }

    .cell.subheader{
      background: #f3f6f9;
      font-weight: 900;
      font-size: 11px;
      color: #0f172a;
      min-height: unset;
      padding: 8px 10px;
      position: sticky;
      top: 36px;
      z-index: 3;
    }

    .cell.subheader.weekend{
      background: rgba(252, 221, 0, 0.16);
    }

    .cell.resource{
      background: #fbfcfe;
      position: sticky;
      left: 0;
      z-index: 2;
      padding: 10px;
    }

    .corner{
      position: sticky;
      top: 0;
      left: 0;
      z-index: 5;
      background: var(--light-gray);
    }

    .corner2{
      position: sticky;
      top: 36px;
      left: 0;
      z-index: 5;
      background: #f3f6f9;
    }

    .resource-row{
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar{
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid #dde3ea;
      background: #fff;
      overflow: hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      color: var(--petrol);
      flex: 0 0 auto;
    }
    .avatar img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }
    .rname{ font-weight: 900; font-size: 12px; }
    .rsub{ font-weight: 700; color: var(--muted); font-size: 11px; margin-top: 2px; }

    .dropzone{
      border-radius: 10px;
      min-height: 84px;
      padding: 8px;
      border: 1px dashed rgba(0, 140, 248, 0.35);
      background: rgba(0, 140, 248, 0.03);
      display:flex;
      flex-direction: column;
      gap: 6px;
      transition: background 120ms ease, border-color 120ms ease;
    }

    .dropzone.weekend{
      background: rgba(252, 221, 0, 0.10);
      border-color: rgba(5, 60, 85, 0.22);
    }

    .dropzone.over{
      background: rgba(0, 140, 248, 0.08);
      border-color: rgba(0, 140, 248, 0.65);
    }

    .cell-tools{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .hint{
      font-size: 11px;
      color: var(--muted);
    }

    /* plus button */
    .plus-btn{
      width: 22px;
      height: 22px;
      border-radius: 7px;
      border: 1px solid rgba(0, 140, 248, 0.30);
      background: rgba(0, 140, 248, 0.08);
      color: #0f172a;
      font-weight: 900;
      font-size: 16px;
      line-height: 18px;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select: none;
    }
    .plus-btn:hover{
      background: rgba(0, 140, 248, 0.12);
      border-color: rgba(0, 140, 248, 0.45);
    }

    /* Small scheduled cards, one line */
    .mini{
      border-radius: 8px;
      padding: 6px 8px;
      border: 1px solid rgba(5, 60, 85, 0.20);
      background: rgba(49, 125, 155, 0.14);
      cursor: grab;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 8px;
    }
    .mini:active{ cursor: grabbing; }

    .mini .line{
      font-size: 11.5px;
      font-weight: 900;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1 1 auto;
    }

    .mini .tag{
      font-size: 10.5px;
      font-weight: 900;
      color: rgba(15, 23, 42, 0.78);
      border: 1px solid rgba(15, 23, 42, 0.12);
      border-radius: 999px;
      padding: 2px 6px;
      background: rgba(255,255,255,0.6);
      flex: 0 0 auto;
    }

    .mini.leave{
      border-color: rgba(160, 13, 28, 0.25);
      background: rgba(252, 221, 0, 0.22);
      cursor: pointer;
    }

    .mini.holiday{
      border-color: rgba(5, 60, 85, 0.22);
      background: rgba(252, 221, 0, 0.32);
      cursor: grab;
    }

    .footer-note{
      padding: 10px 14px;
      border-top: 1px solid #e5e7eb;
      font-size: 12px;
      color: var(--muted);
      background: #fff;
    }

    /* Modal */
    .modal-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width: 560px;
      max-width: 100%;
      background: #fff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 60px rgba(0,0,0,0.22);
      overflow: hidden;
    }
    .modal-header{
      padding: 12px 14px;
      border-bottom: 1px solid #e5e7eb;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      background: var(--light-gray);
    }
    .modal-title{
      font-weight: 900;
      font-size: 13px;
      margin: 0;
    }
    .modal-body{
      padding: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      font-size: 12px;
      color: #0f172a;
    }
    .kv{
      display:grid;
      grid-template-columns: 170px 1fr;
      gap: 8px 10px;
      align-items: start;
    }
    .k{ color: var(--muted); font-weight: 900; }
    .v{ font-weight: 900; }
    .modal-actions{
      padding: 12px 14px;
      border-top: 1px solid #e5e7eb;
      display:flex;
      justify-content: flex-end;
      gap: 8px;
      background: #fff;
    }

    @media (max-width: 1100px){
      .layout{ grid-template-columns: 1fr; }
      .excel{ min-width: 1100px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <img class="logo" src="assets/epicor-logo.svg" alt="Epicor" onerror="this.style.display='none'"/>
    <div class="title-wrap">
      <h1>Weekly Resource Calendar</h1>
      <div class="subtitle">Holiday applies to both shifts, drag a holiday onto another day to extend it</div>
    </div>
  </div>

  <div class="container">
    <div class="layout">
      <!-- Backlog -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="heading">Job Backlog</div>
            <div class="hint">Drag a job onto a resource, day and shift</div>
          </div>
          <div class="controls">
            <button class="btn btn-secondary" onclick="resetDemo()">Reset</button>
            <button class="btn btn-warn" onclick="autoFillDemo()">Auto Fill</button>
          </div>
        </div>

        <div class="backlog" id="backlog"></div>

        <div class="footer-note">
          Demo mode only. Later this becomes Epicor REST reads and updates.
        </div>
      </div>

      <!-- Board -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="heading">Schedule, weekly</div>
            <div class="hint">Shift Filter controls visible shift columns</div>
          </div>
          <div class="controls">
            <label style="font-size:12px; font-weight:900; color:#111827;">Shift Filter</label>
            <select id="shiftFilter" class="select" onchange="setShiftFilter(this.value)">
              <option value="both">Day and Night</option>
              <option value="day">Day only</option>
              <option value="night">Night only</option>
            </select>
            <button class="btn btn-primary" onclick="saveChanges()">Save Changes</button>
          </div>
        </div>

        <div class="board-wrap">
          <div class="excel" id="board"></div>
        </div>

        <div class="footer-note">
          Tip: drag a holiday card onto another day cell to extend its end date.
        </div>
      </div>
    </div>
  </div>

  <!-- Details modal -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModalIfBackdrop(event)">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Details</div>
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal()">Done</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Demo data ----------
    const demoResources = [
      { id: "EMP001", name: "John Smith", group: "Assembly", photo: "assets/employees/EMP001.jpg" },
      { id: "EMP002", name: "Sarah Lee", group: "Welding",  photo: "assets/employees/EMP002.jpg" },
      { id: "EMP003", name: "Michael Tran", group: "Paint",   photo: "assets/employees/EMP003.jpg" },
      { id: "EMP004", name: "Aisha Khan", group: "Assembly",  photo: "assets/employees/EMP004.jpg" }
    ];

    // Job fields: Job Number, Part Number, Customer Number, Part Description, Quantity, Duration
    const demoJobs = [
      { kind: "job", jobNumber: "J-10021", partNumber: "PN-AX12", customerNumber: "CUST-1000", partDescription: "Switchboard enclosure", quantity: 2, durationHours: 6 },
      { kind: "job", jobNumber: "J-10034", partNumber: "PN-WR08", customerNumber: "CUST-1042", partDescription: "Panel wiring kit", quantity: 4, durationHours: 4 },
      { kind: "job", jobNumber: "J-10040", partNumber: "PN-FAT01", customerNumber: "CUST-1000", partDescription: "Factory acceptance test", quantity: 1, durationHours: 3 },
      { kind: "job", jobNumber: "J-10055", partNumber: "PN-SM22", customerNumber: "CUST-1108", partDescription: "Sheet metal set", quantity: 6, durationHours: 5 },
      { kind: "job", jobNumber: "J-10080", partNumber: "PN-PC09", customerNumber: "CUST-1205", partDescription: "Powder coat prep batch", quantity: 3, durationHours: 4 },
      { kind: "job", jobNumber: "J-10110", partNumber: "PN-PK02", customerNumber: "CUST-1310", partDescription: "Packaging and labels", quantity: 10, durationHours: 2 }
    ];

    const SHIFTS = [
      { key: "day", label: "Day" },
      { key: "night", label: "Night" }
    ];

    let resources = structuredClone(demoResources);
    let backlogJobs = structuredClone(demoJobs);

    // schedule cellKey -> array of items (jobs, leave)
    // cellKey format: resourceId|YYYY-MM-DD|shiftKey
    let schedule = {};

    // holidayRanges: apply to whole day (both shifts)
    // { id, resourceId, startDayKey, endDayKey, label }
    let holidayRanges = [];

    let shiftFilter = "both"; // both, day, night

    // ---------- Week helpers ----------
    function getWeekMonToSun() {
      const now = new Date();
      const dow = now.getDay(); // 0 Sun .. 6 Sat
      const diffToMonday = (dow === 0 ? -6 : 1) - dow;
      const monday = new Date(now);
      monday.setDate(now.getDate() + diffToMonday);
      monday.setHours(0,0,0,0);

      const days = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        const key = d.toISOString().slice(0,10);
        const label = d.toLocaleDateString(undefined, { weekday: "short", day: "2-digit", month: "short" });
        const isWeekend = d.getDay() === 6 || d.getDay() === 0; // Sat, Sun
        days.push({ key, label, isWeekend });
      }
      return days;
    }
    const weekDays = getWeekMonToSun();

    function makeCellKey(resourceId, dayKey, shiftKey) {
      return `${resourceId}|${dayKey}|${shiftKey}`;
    }

    function getCellItems(cellKey) {
      if (!schedule[cellKey]) schedule[cellKey] = [];
      return schedule[cellKey];
    }

    function getVisibleShifts() {
      if (shiftFilter === "day") return [SHIFTS[0]];
      if (shiftFilter === "night") return [SHIFTS[1]];
      return SHIFTS;
    }

    function setShiftFilter(val) {
      shiftFilter = val;
      renderBoard();
    }

    // ---------- Holiday helpers ----------
    function inRange(dayKey, startKey, endKey) {
      return dayKey >= startKey && dayKey <= endKey;
    }

    function holidayFor(resourceId, dayKey) {
      return holidayRanges.filter(h => h.resourceId === resourceId && inRange(dayKey, h.startDayKey, h.endDayKey));
    }

    function upsertHolidayExtend(holidayId, targetDayKey) {
      const h = holidayRanges.find(x => x.id === holidayId);
      if (!h) return;
      const minKey = (targetDayKey < h.startDayKey) ? targetDayKey : h.startDayKey;
      const maxKey = (targetDayKey > h.endDayKey) ? targetDayKey : h.endDayKey;
      h.startDayKey = minKey;
      h.endDayKey = maxKey;
    }

    // ---------- Rendering ----------
    function render() {
      renderBacklog();
      renderBoard();
    }

    function renderBacklog() {
      const el = document.getElementById("backlog");
      el.innerHTML = "";

      backlogJobs.forEach(job => el.appendChild(renderBacklogCard(job)));

      if (backlogJobs.length === 0) {
        const empty = document.createElement("div");
        empty.style.color = "#6b7280";
        empty.style.fontSize = "12px";
        empty.textContent = "Backlog empty, all jobs are scheduled.";
        el.appendChild(empty);
      }
    }

    function renderBoard() {
      const board = document.getElementById("board");
      board.innerHTML = "";

      const visibleShifts = getVisibleShifts();
      const columnsPerDay = visibleShifts.length;

      const grid = document.createElement("div");
      grid.className = "grid";
      grid.style.gridTemplateColumns = `280px repeat(${7 * columnsPerDay}, minmax(140px, 1fr))`;

      // Header row 1: day labels spanning shift columns
      const corner = document.createElement("div");
      corner.className = "cell header corner";
      corner.textContent = "Resource";
      grid.appendChild(corner);

      weekDays.forEach(d => {
        const h = document.createElement("div");
        h.className = `cell header${d.isWeekend ? " weekend" : ""}`;
        h.style.gridColumn = `span ${columnsPerDay}`;
        h.textContent = d.label;
        grid.appendChild(h);
      });

      // Header row 2: shift labels
      const corner2 = document.createElement("div");
      corner2.className = "cell subheader corner2";
      corner2.textContent = " ";
      grid.appendChild(corner2);

      weekDays.forEach(d => {
        visibleShifts.forEach(s => {
          const sh = document.createElement("div");
          sh.className = `cell subheader${d.isWeekend ? " weekend" : ""}`;
          sh.textContent = s.label;
          grid.appendChild(sh);
        });
      });

      // Resource rows
      resources.forEach(r => {
        const rc = document.createElement("div");
        rc.className = "cell resource";

        const av = document.createElement("div");
        av.className = "avatar";
        av.innerHTML = `
          <img src="${escapeHtml(r.photo)}" alt="${escapeHtml(r.name)}"
               onerror="this.remove(); this.parentElement.textContent='${escapeHtml(initials(r.name))}'" />
        `;

        const txt = document.createElement("div");
        txt.innerHTML = `
          <div class="rname">${escapeHtml(r.name)}</div>
          <div class="rsub">${escapeHtml(r.group)}, ${escapeHtml(r.id)}</div>
        `;

        const row = document.createElement("div");
        row.className = "resource-row";
        row.appendChild(av);
        row.appendChild(txt);

        rc.appendChild(row);
        grid.appendChild(rc);

        weekDays.forEach(d => {
          visibleShifts.forEach(s => {
            const cellKey = makeCellKey(r.id, d.key, s.key);

            const c = document.createElement("div");
            c.className = "cell";

            const dz = document.createElement("div");
            dz.className = `dropzone${d.isWeekend ? " weekend" : ""}`;
            dz.dataset.cellKey = cellKey;
            dz.dataset.resourceId = r.id;
            dz.dataset.dayKey = d.key;
            dz.dataset.shiftKey = s.key;

            const tools = document.createElement("div");
            tools.className = "cell-tools";

            const left = document.createElement("div");
            left.className = "hint";
            left.textContent = "";

            const plus = document.createElement("button");
            plus.className = "plus-btn";
            plus.type = "button";
            plus.title = "Add leave or holiday";
            plus.textContent = "+";
            plus.onclick = () => openCellMenu(r, d);

            tools.appendChild(left);
            tools.appendChild(plus);
            dz.appendChild(tools);

            dz.addEventListener("dragover", (e) => {
              e.preventDefault();
              dz.classList.add("over");
            });
            dz.addEventListener("dragleave", () => dz.classList.remove("over"));
            dz.addEventListener("drop", (e) => {
              e.preventDefault();
              dz.classList.remove("over");
              const payload = safeParse(e.dataTransfer.getData("text/plain"));
              if (!payload) return;
              handleDrop(payload, cellKey, r.id, d.key);
            });

            // If a holiday applies to this resource and day, show it in BOTH shifts
            // For "both shifts", we render the holiday card in every visible shift cell that day.
            const holidays = holidayFor(r.id, d.key);
            holidays.forEach(h => dz.appendChild(renderHolidayMini(h, r, d, s)));

            const items = getCellItems(cellKey);

            if (holidays.length === 0 && items.length === 0) {
              const hint = document.createElement("div");
              hint.className = "hint";
              hint.textContent = "Drop job here";
              dz.appendChild(hint);
            } else {
              items.forEach((it, idx) => dz.appendChild(renderJobMini(it, cellKey, idx, r, d, s)));
            }

            c.appendChild(dz);
            grid.appendChild(c);
          });
        });
      });

      board.appendChild(grid);
    }

    // Backlog card
    function renderBacklogCard(job) {
      const card = document.createElement("div");
      card.className = "job";
      card.draggable = true;

      card.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", JSON.stringify({
          type: "job",
          from: "backlog",
          jobNumber: job.jobNumber,
          item: job
        }));
        e.dataTransfer.effectAllowed = "move";
      });

      card.innerHTML = `
        <div class="top">
          <div class="name">${escapeHtml(job.jobNumber)}, ${escapeHtml(job.partDescription)}</div>
          <span class="badge">${escapeHtml(job.durationHours + "h")}</span>
        </div>
        <div class="meta">
          <span>${escapeHtml(job.partNumber)}</span>
          <span>${escapeHtml(job.customerNumber)}</span>
          <span>Qty ${escapeHtml(String(job.quantity))}</span>
        </div>
      `;
      return card;
    }

    function renderJobMini(item, cellKey, indexInCell, resource, day, shift) {
      const card = document.createElement("div");
      card.className = "mini";
      card.draggable = true;

      card.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", JSON.stringify({
          type: "job",
          from: "scheduled",
          jobNumber: item.jobNumber,
          sourceCellKey: cellKey,
          sourceIndex: indexInCell,
          item: item
        }));
        e.dataTransfer.effectAllowed = "move";
      });

      card.onclick = (ev) => {
        ev.stopPropagation();
        openDetails(item, { resource, day, shift, cellKey });
      };

      card.innerHTML = `
        <div class="line">${escapeHtml(item.jobNumber)}, ${escapeHtml(item.partNumber)}</div>
        <div class="tag">${escapeHtml(item.durationHours + "h")}</div>
      `;
      return card;
    }

    // Holiday mini is draggable, dropping it onto another day extends the range
    function renderHolidayMini(h, resource, day, shift) {
      const card = document.createElement("div");
      card.className = "mini holiday";
      card.draggable = true;

      card.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", JSON.stringify({
          type: "holiday",
          holidayId: h.id,
          resourceId: h.resourceId,
          anchorDayKey: day.key
        }));
        e.dataTransfer.effectAllowed = "move";
      });

      card.onclick = (ev) => {
        ev.stopPropagation();
        openDetails({ kind: "holiday", label: h.label, startDayKey: h.startDayKey, endDayKey: h.endDayKey }, { resource, day, shift });
      };

      const rangeText = (h.startDayKey === h.endDayKey) ? "HOLIDAY" : "HOLIDAY RANGE";
      card.innerHTML = `
        <div class="line">${escapeHtml(h.label)}</div>
        <div class="tag">${escapeHtml(rangeText)}</div>
      `;
      return card;
    }

    // ---------- Drag drop logic ----------
    function handleDrop(payload, targetCellKey, targetResourceId, targetDayKey) {
      if (!payload) return;

      // Extend holiday by dragging it onto another day for the SAME resource
      if (payload.type === "holiday") {
        if (payload.resourceId !== targetResourceId) return;
        upsertHolidayExtend(payload.holidayId, targetDayKey);
        renderBoard();
        return;
      }

      if (payload.type !== "job") return;

      if (payload.from === "backlog") {
        backlogJobs = backlogJobs.filter(j => j.jobNumber !== payload.jobNumber);
        getCellItems(targetCellKey).push(payload.item);
        renderBacklog();
        renderBoard();
        return;
      }

      if (payload.from === "scheduled") {
        const srcKey = payload.sourceCellKey;
        const srcIdx = payload.sourceIndex;

        if (!srcKey || srcKey === targetCellKey) return;

        const srcItems = getCellItems(srcKey);
        const moving = srcItems[srcIdx];
        if (!moving) return;

        srcItems.splice(srcIdx, 1);
        getCellItems(targetCellKey).push(moving);

        if (srcItems.length === 0) delete schedule[srcKey];

        renderBoard();
        return;
      }
    }

    // ---------- Add menu ----------
    // Holiday applies to whole day (both shifts), so it is stored as a range by resource and day.
    function openCellMenu(resource, day) {
      const choice = prompt(
        "Type: leave, holiday, clear, cancel\n\nleave = add leave in the selected cell only\nholiday = add holiday for the whole day (both shifts)\nclear = remove jobs and leave for the selected shift cell\ncancel = do nothing",
        "holiday"
      );
      if (!choice) return;

      const c = choice.trim().toLowerCase();
      if (c === "cancel") return;

      if (c === "holiday") {
        const label = prompt("Holiday label", "Public Holiday");
        if (!label) return;

        holidayRanges.push({
          id: `H-${Date.now()}-${Math.floor(Math.random()*1000)}`,
          resourceId: resource.id,
          startDayKey: day.key,
          endDayKey: day.key,
          label: label
        });
        renderBoard();
        return;
      }

      if (c === "leave") {
        // Leave is shift-specific, user will click plus inside a shift cell, but prompt is global.
        // To keep UI simple, we add leave to DAY shift by default when both are visible,
        // or to the currently visible shift if filtered.
        const label = prompt("Leave label", "Leave");
        if (!label) return;

        const visible = getVisibleShifts();
        const targetShift = visible[0]?.key || "day";
        const cellKey = makeCellKey(resource.id, day.key, targetShift);
        getCellItems(cellKey).unshift({ kind: "leave", label: label, notes: "Leave" });
        renderBoard();
        return;
      }

      if (c === "clear") {
        // clear prompt cannot know shift cell, so we just clear both shifts for that day
        SHIFTS.forEach(s => {
          const ck = makeCellKey(resource.id, day.key, s.key);
          delete schedule[ck];
        });
        renderBoard();
        return;
      }

      alert("Unknown option. Use leave, holiday, clear, cancel.");
    }

    // ---------- Details modal ----------
    function openDetails(item, ctx) {
      const resource = ctx?.resource;
      const day = ctx?.day;
      const shift = ctx?.shift;

      const title = item.kind === "job"
        ? `${item.jobNumber}`
        : (item.label || "Details");

      document.getElementById("modalTitle").textContent = title;

      const rows = [];
      if (resource) rows.push(["Resource", `${resource.name} (${resource.id})`]);
      if (day) rows.push(["Date", day.label]);
      if (shift) rows.push(["Shift", shift.label]);

      if (item.kind === "job") {
        rows.push(["Job Number", item.jobNumber || ""]);
        rows.push(["Part Number", item.partNumber || ""]);
        rows.push(["Customer Number", item.customerNumber || ""]);
        rows.push(["Part Description", item.partDescription || ""]);
        rows.push(["Quantity", String(item.quantity ?? "")]);
        rows.push(["Duration", `${item.durationHours ?? ""} hours`]);
      } else if (item.kind === "holiday") {
        rows.push(["Type", "HOLIDAY"]);
        if (item.startDayKey && item.endDayKey) rows.push(["Range", `${item.startDayKey} to ${item.endDayKey}`]);
      } else if (item.kind === "leave") {
        rows.push(["Type", "LEAVE"]);
      }

      const body = document.getElementById("modalBody");
      body.innerHTML = `
        <div class="kv">
          ${rows.map(([k,v]) => `
            <div class="k">${escapeHtml(k)}</div>
            <div class="v">${escapeHtml(v)}</div>
          `).join("")}
        </div>
      `;

      document.getElementById("modalOverlay").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("modalOverlay").style.display = "none";
    }

    function closeModalIfBackdrop(e) {
      if (e.target && e.target.id === "modalOverlay") closeModal();
    }

    // ---------- Save and reset ----------
    function autoFillDemo() {
      const visibleShifts = getVisibleShifts();
      const cells = [];
      resources.forEach(r => {
        weekDays.forEach(d => {
          visibleShifts.forEach(s => cells.push(makeCellKey(r.id, d.key, s.key)));
        });
      });

      let i = 0;
      while (backlogJobs.length > 0 && i < cells.length) {
        const ck = cells[i];
        getCellItems(ck).push(backlogJobs.shift());
        i++;
      }
      render();
    }

    function saveChanges() {
      const out = [];

      // jobs and leave
      Object.keys(schedule).forEach(cellKey => {
        const [resourceId, dayKey, shiftKey] = cellKey.split("|");
        schedule[cellKey].forEach(it => {
          out.push({
            resourceId,
            day: dayKey,
            shift: shiftKey,
            kind: it.kind,
            jobNumber: it.kind === "job" ? it.jobNumber : null,
            partNumber: it.kind === "job" ? it.partNumber : null,
            customerNumber: it.kind === "job" ? it.customerNumber : null,
            partDescription: it.kind === "job" ? it.partDescription : null,
            quantity: it.kind === "job" ? it.quantity : null,
            durationHours: it.kind === "job" ? it.durationHours : null,
            label: it.kind !== "job" ? it.label : null
          });
        });
      });

      // holidays (whole-day)
      holidayRanges.forEach(h => {
        out.push({
          resourceId: h.resourceId,
          kind: "holiday",
          startDay: h.startDayKey,
          endDay: h.endDayKey,
          label: h.label,
          appliesTo: "both_shifts"
        });
      });

      console.log("Schedule payload:", out);
      alert("Saved (demo). Check console for schedule payload.");
    }

    function resetDemo() {
      resources = structuredClone(demoResources);
      backlogJobs = structuredClone(demoJobs);
      schedule = {};
      holidayRanges = [];
      shiftFilter = "both";
      document.getElementById("shiftFilter").value = "both";
      render();
    }

    // ---------- Utilities ----------
    function safeParse(s) { try { return JSON.parse(s); } catch { return null; } }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function initials(name) {
      const parts = String(name || "").trim().split(/\s+/).filter(Boolean);
      const a = parts[0]?.[0] || "E";
      const b = parts[1]?.[0] || "";
      return (a + b).toUpperCase();
    }

    render();
  </script>
</body>
</html>
